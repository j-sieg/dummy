require "test_helper"

class <%= class_name.pluralize %>::ResetPasswordsControllerTest < ActionDispatch::IntegrationTest
  test "#new doesn't crash" do
    get <%= plural_name %>_forgot_my_password_url
    assert_response :success
  end

  test "#create with a non-existent <%= singular_name %> email" do
    post <%= plural_name %>_forgot_my_password_url, params: {email: "non_existent_<%= singular_name %>@ecorp.com"}

    perform_enqueued_jobs
    assert_emails 0
    assert_equal \
      "If your email address exists in our database, you will receive an email with instructions on how to reset your password in a few minutes.",
      flash[:notice]
  end

  test "#create when a <%= singular_name %> is unconfirmed" do
    <%= singular_name %> = <%= plural_name %>(:unconfirmed)
    post <%= plural_name %>_forgot_my_password_url, params: {email: <%= singular_name %>.email}

    perform_enqueued_jobs
    assert_emails 0
    assert_equal \
      "If your email address exists in our database, you will receive an email with instructions on how to reset your password in a few minutes.",
      flash[:notice]
  end

  test "#create when a <%= singular_name %> is confirmed" do
    <%= singular_name %> = <%= plural_name %>(:james)
    post <%= plural_name %>_forgot_my_password_url, params: {email: <%= singular_name %>.email}

    perform_enqueued_jobs
    assert_emails 1
    assert_equal \
      "If your email address exists in our database, you will receive an email with instructions on how to reset your password in a few minutes.",
      flash[:notice]
  end

  test "#edit with a valid token" do
    <%= singular_name %> = <%= plural_name %>(:james)
    encoded_token = <%= class_name %>Token.create_reset_password_token!(<%= singular_name %>).encoded_token

    get <%= plural_name %>_edit_reset_my_password_url(token: encoded_token)
    assert_response :success
  end

  test "#edit when a token is invalid" do
    get <%= plural_name %>_edit_reset_my_password_url(token: "invalid token")
    assert_redirected_to <%= plural_name %>_login_url
    assert_equal "The link might have expired or is invalid.", flash[:alert]
  end

  test "#edit when a token has expired" do
    <%= singular_name %> = <%= plural_name %>(:james)
    encoded_token = <%= class_name %>Token.create_reset_password_token!(<%= singular_name %>).encoded_token

    travel_to (1.hour.from_now + 5.seconds) do
      get <%= plural_name %>_edit_reset_my_password_url(token: encoded_token)
      assert_redirected_to <%= plural_name %>_login_url
      assert_equal "The link might have expired or is invalid.", flash[:alert]
    end
  end

  test "#update when the token is invalid" do
    patch <%= plural_name %>_update_reset_my_password_url(token: "dummy token")
    assert_equal "The link might have expired or is invalid.", flash[:alert]
    assert_redirected_to <%= plural_name %>_login_url
  end

  test "#update when the token has expired" do
    <%= singular_name %> = <%= plural_name %>(:josh)
    encoded_token = <%= class_name %>Token.create_reset_password_token!(<%= singular_name %>).encoded_token

    travel_to (1.hour.from_now + 5.seconds) do
      patch <%= plural_name %>_update_reset_my_password_url(token: encoded_token)
      assert_equal "The link might have expired or is invalid.", flash[:alert]
      assert_redirected_to <%= plural_name %>_login_url
    end
  end

  test "#update when successful" do
    <%= singular_name %> = <%= plural_name %>(:josh)
    encoded_token = <%= class_name %>Token.create_reset_password_token!(<%= singular_name %>).encoded_token
    valid_params = {
      <%= singular_name %>: {password: "sup3rSecure!", password_confirmation: "sup3rSecure!"}
    }

    # The session token and the reset password token.
    assert_difference ["<%= singular_name %>.tokens.count"], -2 do
      patch <%= plural_name %>_update_reset_my_password_url(token: encoded_token), params: valid_params
    end
    assert_redirected_to <%= plural_name %>_login_url
    assert_equal \
      "Successfully reset your password!",
      flash[:notice]
  end
end